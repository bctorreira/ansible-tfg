---
- name: Install varnish package
  package:
    name: varnish
    state: latest

- name: Create configuration directory
  file:
    path: /etc/varnish/conf.d/
    state: directory

- name: Send backends.vcl template
  template:
    src: templates/backends.vcl.j2
    dest: /etc/varnish/conf.d/backends.vcl
    owner: root
    group: root
    mode: "0644"
  notify: Reload varnish services

- name: Send acls.vcl template
  template:
    src: templates/acls.vcl.j2
    dest: /etc/varnish/conf.d/acls.vcl
    owner: root
    group: root
    mode: "0644"
  notify: Reload varnish services

- name: Send error.vcl template
  template:
    src: templates/error.vcl.j2
    dest: /etc/varnish/conf.d/error.vcl
    owner: root
    group: root
    mode: "0644"
  notify: Reload varnish services

- name: Send default.vcl template
  template:
    src: templates/default.vcl.j2
    dest: /etc/varnish/default.vcl
    owner: root
    group: root
    mode: "0644"
  notify: Reload varnish services

- name: Send remaining varnish configuration files
  copy:
    src: varnish_conf/
    dest: /etc
    owner: root
    group: root
    mode: "0644"
  notify: Reload varnish services

- name: Check if netdata is installed
  stat:
    path: /opt/netdata/usr/sbin/netdata
  register: nd

- name: Add netdata user to varnish group if netdata is installed
  user:
    name: netdata
    groups: varnish
    append: yes
  when: nd.stat.exists
  notify: Restart netdata service
